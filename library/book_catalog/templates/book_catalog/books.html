{% extends "base.html" %}

{% load static %}

{% block content %}
    <p>{{ content }}</p>

    <div class="filter-dropdown">
        <button class="btn btn-secondary" id="filter-button">Фильтры</button>
        <div class="filter-options" id="filter-options">
            <form method="GET" action="{% url 'book_catalog:index' %}">
                <div class="form-group">
                    <label for="author">Автор:</label>
                    <select id="author" name="author" class="form-control">
                        <option value="" {% if not request.GET.author %}selected{% endif %}>Любой</option>
                        {% for author in authors %}
                            <option value="{{ author.id }}" {% if author.id|stringformat:"s" == request.GET.author %}selected{% endif %}>
                                {{ author.first_name }} {{ author.last_name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="genre">Жанр:</label>
                    <select id="genre" name="genre" class="form-control">
                        <option value="" {% if not request.GET.genre %}selected{% endif %}>Любой</option>
                        {% for genre in genres %}
                            <option value="{{ genre.id }}" {% if genre.id|stringformat:"s" == request.GET.genre %}selected{% endif %}>
                                {{ genre.genre }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="age_restriction">Возрастное ограничение:</label>
                    <select id="age_restriction" name="age_restriction" class="form-control">
                        <option value="" {% if not request.GET.age_restriction %}selected{% endif %}>Любое</option>
                        {% for age in age_restrictions %}
                            <option value="{{ age }}" {% if age|stringformat:"s" == request.GET.age_restriction %}selected{% endif %}>
                                {{ age }}+
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">Применить</button>
            </form>
        </div>
    </div>

    <div class="cards">
        {% for book in books %}
            <div class="book">
                <div class="cover">
                    {% if book.image %}
                        <a href="{% url "book_catalog:book" book.slug %}">
                            <img src="{{ book.image.url }}" alt="{{ book.name }}">
                        </a>
                    {% else %}
                        <a href="{% url "book_catalog:book" book.slug %}">
                            <img src="{% static "library_static/images/image-not-found.jpg" %}" alt="...">
                        </a>
                    {% endif %}
                </div>
                <div class="description">
                    <p class="title">{{ book.title }}<br>
                        <span class="author">{{ book.author.first_name }} {{ book.author.last_name }}</span>
                    </p>
                    <p class="age">{{ book.age_restriction }}+</p>
                </div>

                <div class="btn-group">
                    {% if user.is_authenticated %}
                        <a href="{% url "booking:select_book_instance" book.id %}" class="btn btn-sm btn-outline-secondary">Забронировать</a>
                    {% else %}
                        <a href="{% url 'users:login' %}" class="btn btn-sm btn-outline-secondary">Забронировать</a>
                    {% endif %}
                </div>
            </div>
        {% endfor %}
    </div>

    <div class="paginator">
        <ul class="pagination">
            <div class="page-item-class">
                <li class="page-item {% if not books.has_previous %}disabled{% endif %}">
                    <a class="page-link" href="{% if books.has_previous %}
                        {% url "book_catalog:index" books.previous_page_number %}
                    {% else %} #
                    {% endif %}">Предыдущая</a>
                </li>

                {% for page in books.paginator.page_range %}
                    {% if page >= books.number|add:-2 and page <= books.number|add:2 %}
                        <li class="page-item {% if books.number == page%}disabled{% endif %}">
                            <a class="page-link" href="{% url "book_catalog:index" page %}">{{page}}</a>
                        </li>
                    {% endif %}
                {% endfor %}

                <li class="page-item {% if not books.has_next %}disabled{% endif %}">
                    <a class="page-link" href="{% if books.has_next %}
                        {% url "book_catalog:index" books.next_page_number %}
                    {% else %} #
                    {% endif %}">Следующая</a>
                </li>
            </div>
        </ul>
    </div>

    <button style="background-color: #ddd; color: black; border: none; border-radius: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.3s, transform 0.2s;" 
        onclick="exportToJson()">Выгрузить в JSON</button>

    <button style="background-color: #ddd; color: black; border: none; border-radius: 5px; padding: 10px 20px; font-size: 16px; cursor: pointer; transition: background-color 0.3s, transform 0.2s;"
            onclick="exportToCsv()">Выгрузить в CSV</button>

    <script>
        function getQueryString() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.toString();
        }

        function exportToJson() {
            const queryString = getQueryString();
            window.location.href = "{% url 'book_catalog:export_books_to_json' %}?" + queryString;
        }

        function exportToCsv() {
            const queryString = getQueryString();
            window.location.href = "{% url 'book_catalog:export_books_to_csv' %}?" + queryString;
        }
    </script>

{% endblock content %}
