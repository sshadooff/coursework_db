{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static "library_static/css/style.css" %}">
    <link rel="stylesheet" href="{% static "library_static/css/books_style.css" %}">
    <link rel="stylesheet" href="{% static "library_static/css/book_style.css" %}">
    <link rel="stylesheet" href="{% static "library_static/css/booking_issuance.css" %}">
    <link rel="stylesheet" href="{% static "library_static/css/login_registration.css" %}">
    <title>{{ title }}</title>
</head>
<body>
  <div class="conteiner">
    <header class="d-flex justify-content-center py-3">
      <ul class="nav nav-pills">
        <li class="nav-item"><a href="{% url "main:index" %}" class="nav-link active" aria-current="page">Главная</a></li>
        <li class="nav-item"><a href="{% url "book_catalog:index" %}" class="nav-link">Каталог книг</a></li>
        {% if not user.is_authenticated %}
        <li class="nav-item"><a href="{% url "users:login" %}" class="nav-link">Вход/Регистрация</a></li>
        {% else %}
          <li class="nav-item"><a href="{% url "issuance:index" %}" class="nav-link">Выдача</a></li>
          <li class="nav-item"><a href="{% url "booking:index" %}" class="nav-link">Бронирование</a></li>
          <li class="nav-item has-submenu">
            <a href="#" class="nav-link">Личный кабинет</a>
            <ul class="submenu">
              <li><a href="{% url "users:profile" %}">Профиль</a></li>
              {% if user.is_admin or user.is_staff %}
                <li><a href="{% url "admin:index" %}">Админ-панель</a></li>
              {% endif %}
              <li><a href="{% url "users:logout" %}">Выход</a></li>
            </ul>
          </li>
        {% endif %}
      </ul>
    </header>
  
    <div class="screen">
      {% include "includes/notifications.html" %}
      {% block content %}{% endblock content %}
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script>
    $(document).ready(function() {
      let page = parseInt(getParameterByName('page')) || 1; 
      let loading = false; 
      let hasMoreBooks = true; 
      let showAll = !!getParameterByName('show_all'); 
      let author = getParameterByName('author');
      let genre = getParameterByName('genre');
      let ageRestriction = getParameterByName('age_restriction');
  
      function loadMore() {
          if (loading || !hasMoreBooks || showAll) return; // Не загружать, если идет процесс загрузки, больше книг нет или show_all установлен
  
          loading = true; 
          let nextPage = page + 1; 
  
          // Отправляем GET-запрос для получения следующей страницы книг с текущими параметрами фильтров
          $.get(`?page=${nextPage}&author=${author || ''}&genre=${genre || ''}&age_restriction=${ageRestriction || ''}`, function(data) {
              const $response = $('<div>').html(data);
              const newBooks = $response.find('.book'); 
  
              if (newBooks.length > 0) {
                  $('.cards').append(newBooks); 
                  page++; 
              } else {
                  hasMoreBooks = false; 
                  $('.screen').off('scroll', scrollHandler); 
              }
              loading = false; 
          }).fail(function() {
              loading = false; 
          });
      }
  
      function scrollHandler() {
          if ($('.screen').scrollTop() + $('.screen').innerHeight() >= $('.screen')[0].scrollHeight - 100) {
              loadMore(); 
          }
      }
  
      $('.screen').on('scroll', scrollHandler);
  
      function getParameterByName(name) {
          const url = window.location.href;
          name = name.replace(/[\[\]]/g, '\\$&');
          const regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
              results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return '';
          return decodeURIComponent(results[2].replace(/\+/g, ' '));
      }
    });
  </script>
  
</body>
</html>